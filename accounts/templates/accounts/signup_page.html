<!DOCTYPE html>
<html>
<head>
  <title>Signup</title>
</head>
<body>
  <h2>Signup Page</h2>
  <form id="signupForm">
    <label for="username">Username:</label><br>
    <input type="text" id="username" required /><br><br>

    <label for="first_name">First Name:</label><br>
    <input type="text" id="first_name" required /><br><br>

    <label for="last_name">Last Name:</label><br>
    <input type="text" id="last_name" required /><br><br>

    <label for="email">Email:</label><br>
    <input type="email" id="email" required /><br><br>

    <label for="password">Password:</label><br>
    <input type="password" id="password" required /><br><br>

    <label for="password2">Confirm Password:</label><br>
    <input type="password" id="password2" required /><br><br>

    <button type="submit">Sign Up</button>
  </form>

  <p id="message"></p>

  <p>
    <a href="/accounts/signin/" id="signupLink">Sign in</a>
  </p>

  <script>
    const signupForm = document.getElementById('signupForm');
    const messageEl = document.getElementById('message');

    // 🔐 Redirect if already signed in
    const accessToken = localStorage.getItem('access_token');
    if (accessToken) {
      fetch('http://127.0.0.1:8000/accounts/api/token/verify/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: accessToken })
      })
      .then(res => {
        if (res.ok) {
          window.location.href = '/dashboard/';
        }
      });
    }

    // 📝 Handle signup submission
    signupForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const username = document.getElementById('username').value.trim();
      const first_name = document.getElementById('first_name').value.trim();
      const last_name = document.getElementById('last_name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const password2 = document.getElementById('password2').value;

      const signupPayload = {
        username, first_name, last_name, email, password, password2
      };

      try {
        const signupResponse = await fetch('http://127.0.0.1:8000/accounts/api/signup/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(signupPayload)
        });

        const signupData = await signupResponse.json();

        if (signupResponse.ok) {
          // After successful signup, call signin API
          const signinPayload = { email, password };

          const signinResponse = await fetch('http://127.0.0.1:8000/accounts/api/signin/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(signinPayload)
          });

          const signinData = await signinResponse.json();

          if (signinResponse.ok) {
            localStorage.setItem('access_token', signinData.access);
            localStorage.setItem('refresh_token', signinData.refresh);
            window.location.href = '/dashboard/';
          } else {
            messageEl.textContent = signinData.detail || 'Auto-signin failed after signup.';
            messageEl.style.color = 'red';
          }
        } else {
          messageEl.textContent = JSON.stringify(signupData);
          messageEl.style.color = 'red';
        }
      } catch (error) {
        messageEl.textContent = 'Error: ' + error.message;
        messageEl.style.color = 'red';
      }
    });
  </script>
</body>
</html>
