{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f9c74f;
            --danger: #f94144;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .project-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .project-title {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .project-key {
            font-size: 0.9rem;
            padding: 4px 8px;
            background-color: var(--light);
            border-radius: 4px;
            color: var(--gray);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e41b23;
        }

        .btn-light {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .btn-light:hover {
            background-color: #e2e6ea;
        }

        .filters {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-filter {
            display: flex;
            gap: 10px;
            flex-grow: 1;
        }

        .search-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .filter-dropdown {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background-color: white;
            font-size: 0.9rem;
        }

        .task-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .task-column {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .column-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .add-task {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .add-task:hover {
            background-color: var(--light);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-card {
            background-color: white;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .task-title {
            font-weight: 500;
            font-size: 1rem;
        }

        .task-key {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .assigned-to {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--gray);
        }

        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .priority {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .priority-high {
            background-color: #ffccd5;
            color: #e5383b;
        }

        .priority-medium {
            background-color: #ffeca9;
            color: #bb9207;
        }

        .priority-low {
            background-color: #c1fba4;
            color: #389e0d;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close:hover {
            color: var(--danger);
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.3);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .member-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-top: 10px;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .member-name {
            font-weight: 500;
        }

        .member-email {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .task-details {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .detail-label {
            font-weight: 500;
            color: var(--gray);
        }

        .task-description {
            margin: 15px 0;
            padding: 15px;
            background-color: var(--light);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-todo {
            background-color: #e9ecef;
            color: var(--dark);
        }

        .badge-progress {
            background-color: #cfe2ff;
            color: #0a58ca;
        }

        .badge-done {
            background-color: #d1e7dd;
            color: #146c43;
        }

        @media (max-width: 768px) {
            .task-board {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="{% static 'css/dashboard_page.css' %}">
</head>
<body>
  {% include "core/includes/dashboard_page_components/dashboard_page_top_navigation_bar.html" %}

    <div class="container">
        <header>
            <div class="project-info">
                <h1 class="project-title">Project Management</h1>
                <span class="project-key">PM-001</span>
            </div>
            <div class="action-buttons">
                <button class="btn btn-light" id="viewMembersBtn">View Members</button>
                <button class="btn btn-primary" id="addPeopleBtn">Add People</button>
                <button class="btn btn-danger" id="deleteProjectBtn">Delete Project</button>
            </div>
        </header>

        <div class="filters">
            <div class="search-filter">
                <input type="text" class="search-input" placeholder="Search tasks..." id="searchTasks">
                <select class="filter-dropdown" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="TODO">To Do</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="DONE">Done</option>
                </select>
                <select class="filter-dropdown" id="priorityFilter">
                    <option value="all">All Priority</option>
                    <option value="HIGH">High</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="LOW">Low</option>
                </select>
            </div>
        </div>

        <div class="task-board">
            <div class="task-column" id="todoColumn">
                <div class="column-header">
                    <h3 class="column-title">To Do</h3>
                    <button class="add-task" id="addTodoTaskBtn">+</button>
                </div>
                <div class="task-list" id="todoTasks">
                    <!-- Todo tasks will be dynamically added here -->
                </div>
            </div>

            <div class="task-column" id="inProgressColumn">
                <div class="column-header">
                    <h3 class="column-title">In Progress</h3>
                    <button class="add-task" id="addInProgressTaskBtn">+</button>
                </div>
                <div class="task-list" id="inProgressTasks">
                    <!-- In Progress tasks will be dynamically added here -->
                </div>
            </div>

            <div class="task-column" id="doneColumn">
                <div class="column-header">
                    <h3 class="column-title">Done</h3>
                    <button class="add-task" id="addDoneTaskBtn">+</button>
                </div>
                <div class="task-list" id="doneTasks">
                    <!-- Done tasks will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content">
            <span class="close" id="closeTaskDetailModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Task Details</h2>
            </div>
            <div id="taskDetailContent">
                <!-- Task details will be dynamically added here -->
            </div>
            <div class="form-actions">
                <button class="btn btn-danger" id="deleteTaskBtn">Delete Task</button>
                <button class="btn btn-light" id="closeTaskDetailBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <span class="close" id="closeAddTaskModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Add New Task</h2>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label class="form-label" for="taskTitle">Title</label>
                    <input type="text" class="form-control" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskDescription">Description</label>
                    <textarea class="form-control" id="taskDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskPriority">Priority</label>
                    <select class="form-control" id="taskPriority" required>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="LOW">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskStatus">Status</label>
                    <select class="form-control" id="taskStatus" required>
                        <option value="TODO">To Do</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskDueDate">Due Date</label>
                    <input type="datetime-local" class="form-control" id="taskDueDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskStartTime">Start Time</label>
                    <input type="datetime-local" class="form-control" id="taskStartTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskEndTime">End Time</label>
                    <input type="datetime-local" class="form-control" id="taskEndTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskEstimatedDuration">Estimated Duration (HH:MM:SS)</label>
                    <input type="text" class="form-control" id="taskEstimatedDuration" placeholder="03:00:00" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskActualDuration">Actual Duration (HH:MM:SS)</label>
                    <input type="text" class="form-control" id="taskActualDuration" placeholder="02:30:00" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="taskAssignedTo">Assigned To (Email)</label>
                    <input type="email" class="form-control" id="taskAssignedTo" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-light" id="cancelAddTaskBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add People Modal -->
    <div class="modal" id="addPeopleModal">
        <div class="modal-content">
            <span class="close" id="closeAddPeopleModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Add People to Project</h2>
            </div>
            <div class="form-group">
                <input type="text" class="form-control" id="searchPeople" placeholder="Search by name or email...">
            </div>
            <div class="member-list" id="peopleList">
                <!-- Member list will be dynamically added here -->
            </div>
            <div class="form-actions">
                <button class="btn btn-light" id="closeAddPeopleBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- View Members Modal -->
    <div class="modal" id="viewMembersModal">
        <div class="modal-content">
            <span class="close" id="closeViewMembersModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Project Members</h2>
            </div>
            <div class="member-list" id="membersList">
                <!-- Member list will be dynamically added here -->
            </div>
            <div class="form-actions">
                <button class="btn btn-light" id="closeViewMembersBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            BASE_API_URL: 'http://127.0.0.1:8000',
            DEFAULT_ERROR_MESSAGE: 'An error occurred. Please try again later.'
        };
        
        const AUTH = {
            accessToken: localStorage.getItem("access_token"),
            refreshToken: localStorage.getItem("refresh_token")
        };
        
        const pathSegments = window.location.pathname.split('/');
        const projectKey = pathSegments[pathSegments.length - 2] || 'NP';
        
        const API = {
            project: `${CONFIG.BASE_API_URL}/projects/api/projects/${projectKey}`,
            tasks: `${CONFIG.BASE_API_URL}/tasks/api/projects/${projectKey}/tasks/`,
            createTask: `${CONFIG.BASE_API_URL}/tasks/api/projects/${projectKey}/tasks/`,
            updateTask: (taskId) => `${CONFIG.BASE_API_URL}/tasks/api/projects/${projectKey}/tasks/${taskId}`,
            deleteTask: (taskId) => `${CONFIG.BASE_API_URL}/tasks/api/projects/${projectKey}/tasks/${taskId}`,
            searchUser: (pattern) => `${CONFIG.BASE_API_URL}/accounts/api/user/?email_pattern=${pattern}`,
            members: `${CONFIG.BASE_API_URL}/projects/api/projects/${projectKey}/memberships/`,
            availableMembers: `${CONFIG.BASE_API_URL}/projects/api/projects/${projectKey}/memberships/all/`,
            addMember: `${CONFIG.BASE_API_URL}/projects/api/projects/${projectKey}/memberships/add/`,
            removeMember: `${CONFIG.BASE_API_URL}/projects/api/projects/${projectKey}/memberships/remove/`,
            deleteProject: `${CONFIG.BASE_API_URL}/projects/api/projects/${projectKey}`
        };
        
        // Global variables
        let tasks = [];
        let members = [];
        let projectDetails = {};
        
        // DOM Elements
        const todoTasksContainer = document.getElementById('todoTasks');
        const inProgressTasksContainer = document.getElementById('inProgressTasks');
        const doneTasksContainer = document.getElementById('doneTasks');
        const searchTasksInput = document.getElementById('searchTasks');
        const statusFilterSelect = document.getElementById('statusFilter');
        const priorityFilterSelect = document.getElementById('priorityFilter');
        const projectTitleElement = document.querySelector('.project-title');
        const projectKeyElement = document.querySelector('.project-key');
        
        // Modals
        const taskDetailModal = document.getElementById('taskDetailModal');
        const addTaskModal = document.getElementById('addTaskModal');
        const addPeopleModal = document.getElementById('addPeopleModal');
        const viewMembersModal = document.getElementById('viewMembersModal');
        
        // Helper function for API requests
        async function makeRequest(url, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AUTH.accessToken}`
            };
        
            const options = {
                method,
                headers
            };
        
            if (body) {
                options.body = JSON.stringify(body);
            }
        
            try {
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error making request:', error);
                alert(CONFIG.DEFAULT_ERROR_MESSAGE);
                throw error;
            }
        }
        
        // Initialize the application
        async function init() {
            try {
                // Load project details
                projectDetails = await makeRequest(API.project);
                projectTitleElement.textContent = projectDetails.name || 'Project Management';
                projectKeyElement.textContent = projectDetails.key || 'PM-001';
        
                // Load tasks
                await loadTasks();
        
                // Load members
                await loadMembers();
        
                // Set up event listeners
                setupEventListeners();
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }
        
        // Load tasks from API
        async function loadTasks() {
            try {
                tasks = await makeRequest(API.tasks);
                renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }
        
        // Load members from API
        async function loadMembers() {
            try {
                members = await makeRequest(API.members);
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }
        
        // Search users by email pattern
        async function searchUsers(pattern) {
            try {
                const users = await makeRequest(API.searchUser(pattern));
                return users;
            } catch (error) {
                console.error('Error searching users:', error);
                return [];
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Close buttons
            document.getElementById('closeTaskDetailModal').addEventListener('click', () => {
                taskDetailModal.style.display = 'none';
            });
            document.getElementById('closeTaskDetailBtn').addEventListener('click', () => {
                taskDetailModal.style.display = 'none';
            });
            document.getElementById('closeAddTaskModal').addEventListener('click', () => {
                addTaskModal.style.display = 'none';
            });
            document.getElementById('cancelAddTaskBtn').addEventListener('click', () => {
                addTaskModal.style.display = 'none';
            });
            document.getElementById('closeAddPeopleModal').addEventListener('click', () => {
                addPeopleModal.style.display = 'none';
            });
            document.getElementById('closeAddPeopleBtn').addEventListener('click', () => {
                addPeopleModal.style.display = 'none';
            });
            document.getElementById('closeViewMembersModal').addEventListener('click', () => {
                viewMembersModal.style.display = 'none';
            });
            document.getElementById('closeViewMembersBtn').addEventListener('click', () => {
                viewMembersModal.style.display = 'none';
            });
        
            // Action buttons
            document.getElementById('addPeopleBtn').addEventListener('click', async () => {
                try {
                    const availableMembers = await makeRequest(API.availableMembers);
                    renderPeopleList(availableMembers);
                    addPeopleModal.style.display = 'block';
                } catch (error) {
                    console.error('Error loading available members:', error);
                }
            });
        
            document.getElementById('viewMembersBtn').addEventListener('click', () => {
                renderMembersList(members);
                viewMembersModal.style.display = 'block';
            });
        
            document.getElementById('deleteProjectBtn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
                    try {
                        await makeRequest(API.deleteProject, 'DELETE');
                        alert('Project deleted successfully!');
                        window.location.href = '/projects'; // Redirect to projects list
                    } catch (error) {
                        console.error('Error deleting project:', error);
                    }
                }
            });
        
            // Add task buttons
            document.getElementById('addTodoTaskBtn').addEventListener('click', () => {
                document.getElementById('taskStatus').value = 'TODO';
                addTaskModal.style.display = 'block';
            });
        
            document.getElementById('addInProgressTaskBtn').addEventListener('click', () => {
                document.getElementById('taskStatus').value = 'IN_PROGRESS';
                addTaskModal.style.display = 'block';
            });
        
            document.getElementById('addDoneTaskBtn').addEventListener('click', () => {
                document.getElementById('taskStatus').value = 'DONE';
                addTaskModal.style.display = 'block';
            });
        
            // Form submission
            document.getElementById('addTaskForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    priority: document.getElementById('taskPriority').value,
                    status: document.getElementById('taskStatus').value,
                    due_date: document.getElementById('taskDueDate').value,
                    start_time: document.getElementById('taskStartTime').value,
                    end_time: document.getElementById('taskEndTime').value,
                    estimated_duration: document.getElementById('taskEstimatedDuration').value,
                    actual_duration: document.getElementById('taskActualDuration').value,
                    assigned_to: document.getElementById('taskAssignedTo').value
                };
                
                try {
                    await makeRequest(API.createTask, 'POST', formData);
                    await loadTasks(); // Refresh tasks
                    addTaskModal.style.display = 'none';
                    document.getElementById('addTaskForm').reset();
                    alert('Task created successfully!');
                } catch (error) {
                    console.error('Error creating task:', error);
                }
            });
        
            // Search and filter
            searchTasksInput.addEventListener('input', renderTasks);
            statusFilterSelect.addEventListener('change', renderTasks);
            priorityFilterSelect.addEventListener('change', renderTasks);
            
            document.getElementById('searchPeople').addEventListener('input', async function() {
                const searchTerm = this.value.toLowerCase();
                if (searchTerm.length > 2) {
                    try {
                        const filteredMembers = await searchUsers(searchTerm);
                        renderPeopleList(filteredMembers);
                    } catch (error) {
                        console.error('Error searching members:', error);
                    }
                }
            });
        }
        
        // Render tasks
        function renderTasks() {
            // Clear containers
            todoTasksContainer.innerHTML = '';
            inProgressTasksContainer.innerHTML = '';
            doneTasksContainer.innerHTML = '';
            
            // Get filter values
            const searchTerm = searchTasksInput.value.toLowerCase();
            const statusFilter = statusFilterSelect.value;
            const priorityFilter = priorityFilterSelect.value;
            
            // Filter tasks
            const filteredTasks = tasks.filter(task => {
                // Search filter
                const matchesSearch = task.title.toLowerCase().includes(searchTerm) ||
                                      task.key.toLowerCase().includes(searchTerm) ||
                                      (task.description && task.description.toLowerCase().includes(searchTerm));
                
                // Status filter
                const matchesStatus = statusFilter === 'all' || task.status === statusFilter;
                
                // Priority filter
                const matchesPriority = priorityFilter === 'all' || task.priority === priorityFilter;
                
                return matchesSearch && matchesStatus && matchesPriority;
            });
            
            // Render filtered tasks
            filteredTasks.forEach(task => {
                const taskCard = createTaskCard(task);
                
                if (task.status === 'TODO') {
                    todoTasksContainer.appendChild(taskCard);
                } else if (task.status === 'IN_PROGRESS') {
                    inProgressTasksContainer.appendChild(taskCard);
                } else if (task.status === 'DONE') {
                    doneTasksContainer.appendChild(taskCard);
                }
            });
        }
        
        // Create task card
        function createTaskCard(task) {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            taskCard.dataset.taskId = task.id;
            
            // Priority class
            let priorityClass = '';
            switch (task.priority) {
                case 'HIGH':
                    priorityClass = 'priority-high';
                    break;
                case 'MEDIUM':
                    priorityClass = 'priority-medium';
                    break;
                case 'LOW':
                    priorityClass = 'priority-low';
                    break;
            }
            
            // User initials
            let userInitials = '';
            if (task.assigned_to) {
                if (task.assigned_to.first_name && task.assigned_to.last_name) {
                    userInitials = `${task.assigned_to.first_name.charAt(0)}${task.assigned_to.last_name.charAt(0)}`;
                } else {
                    userInitials = task.assigned_to.username.substring(0, 2).toUpperCase();
                }
            }
            
            taskCard.innerHTML = `
                <div class="task-header">
                    <h4 class="task-title">${task.title}</h4>
                    <span class="task-key">${task.key}</span>
                </div>
                <div class="task-footer">
                    <div class="assigned-to">
                        <div class="avatar">${userInitials}</div>
                        <span>${task.assigned_to ? task.assigned_to.username : 'Unassigned'}</span>
                    </div>
                    <span class="priority ${priorityClass}">${task.priority}</span>
                </div>
            `;
            
            // Add click event to show task details
            taskCard.addEventListener('click', () => {
                showTaskDetails(task);
            });
            
            return taskCard;
        }
        
        // Show task details
        function showTaskDetails(task) {
            const taskDetailContent = document.getElementById('taskDetailContent');
            
            // Format dates
            const dueDate = new Date(task.due_date).toLocaleString();
            const startTime = task.start_time ? new Date(task.start_time).toLocaleString() : 'Not set';
            const endTime = task.end_time ? new Date(task.end_time).toLocaleString() : 'Not set';
            const createdAt = new Date(task.created_at).toLocaleString();
            
            // Status badge
            let statusBadge = '';
            switch (task.status) {
                case 'TODO':
                    statusBadge = '<span class="badge badge-todo">To Do</span>';
                    break;
                case 'IN_PROGRESS':
                    statusBadge = '<span class="badge badge-progress">In Progress</span>';
                    break;
                case 'DONE':
                    statusBadge = '<span class="badge badge-done">Done</span>';
                    break;
            }
            
            // Priority badge
            let priorityClass = '';
            switch (task.priority) {
                case 'HIGH':
                    priorityClass = 'priority-high';
                    break;
                case 'MEDIUM':
                    priorityClass = 'priority-medium';
                    break;
                case 'LOW':
                    priorityClass = 'priority-low';
                    break;
            }
            
            taskDetailContent.innerHTML = `
                <h3>${task.title} <span class="task-key">${task.key}</span></h3>
                <div class="task-details">
                    <div class="detail-label">Status:</div>
                    <div>${statusBadge}</div>
                    
                    <div class="detail-label">Priority:</div>
                    <div><span class="priority ${priorityClass}">${task.priority}</span></div>
                    
                    <div class="detail-label">Assigned to:</div>
                    <div>${task.assigned_to ? `${task.assigned_to.first_name} ${task.assigned_to.last_name} (${task.assigned_to.email})` : 'Unassigned'}</div>
                    
                    <div class="detail-label">Due date:</div>
                    <div>${dueDate}</div>
                    
                    <div class="detail-label">Start time:</div>
                    <div>${startTime}</div>
                    
                    <div class="detail-label">End time:</div>
                    <div>${endTime}</div>
                    
                    <div class="detail-label">Est. duration:</div>
                    <div>${task.estimated_duration || 'Not set'}</div>
                    
                    <div class="detail-label">Act. duration:</div>
                    <div>${task.actual_duration || 'Not set'}</div>
                    
                    <div class="detail-label">Created at:</div>
                    <div>${createdAt}</div>
                </div>
                
                <div class="detail-label">Description:</div>
                <div class="task-description">${task.description || 'No description provided.'}</div>
            `;
            
            // Set up delete button
            document.getElementById('deleteTaskBtn').dataset.taskId = task.id;
            document.getElementById('deleteTaskBtn').onclick = async function() {
                await deleteTask(task.id);
            };
            
            // Show modal
            taskDetailModal.style.display = 'block';
        }
        
        // Delete task
        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
                try {
                    await makeRequest(API.deleteTask(taskId), 'DELETE');
                    await loadTasks(); // Refresh tasks
                    taskDetailModal.style.display = 'none';
                    alert('Task deleted successfully!');
                } catch (error) {
                    console.error('Error deleting task:', error);
                }
            }
        }
        
        // Render people list
        function renderPeopleList(peopleArray) {
            const peopleList = document.getElementById('peopleList');
            peopleList.innerHTML = '';
            
            peopleArray.forEach(person => {
                const personItem = document.createElement('div');
                personItem.className = 'member-item';
                
                personItem.innerHTML = `
                    <div class="member-info">
                        <div class="avatar">${person.first_name ? person.first_name.charAt(0) : ''}${person.last_name ? person.last_name.charAt(0) : ''}</div>
                        <div>
                            <div class="member-name">${person.first_name} ${person.last_name}</div>
                            <div class="member-email">${person.email}</div>
                        </div>
                    </div>
                    <button class="btn btn-primary">Add</button>
                `;
                
                // Add click event for the Add button
                const addButton = personItem.querySelector('.btn');
                addButton.addEventListener('click', async () => {
                    try {
                        await makeRequest(API.addMember, 'POST', { user_id: person.id });
                        await loadMembers(); // Refresh members list
                        alert(`Added ${person.first_name} ${person.last_name} to the project!`);
                    } catch (error) {
                        console.error('Error adding member:', error);
                    }
                });
                
                peopleList.appendChild(personItem);
            });
        }
        
        // Render members list
        function renderMembersList(membersArray) {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            membersArray.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                
                memberItem.innerHTML = `
                    <div class="member-info">
                        <div class="avatar">${member.first_name ? member.first_name.charAt(0) : ''}${member.last_name ? member.last_name.charAt(0) : ''}</div>
                        <div>
                            <div class="member-name">${member.first_name} ${member.last_name}</div>
                            <div class="member-email">${member.email}</div>
                        </div>
                    </div>
                    <button class="btn btn-danger">Remove</button>
                `;
                
                // Add click event for the Remove button
                const removeButton = memberItem.querySelector('.btn');
                removeButton.addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to remove ${member.first_name} ${member.last_name} from the project?`)) {
                        try {
                            await makeRequest(API.removeMember, 'POST', { user_id: member.id });
                            await loadMembers(); // Refresh members list
                            alert(`Removed ${member.first_name} ${member.last_name} from the project!`);
                        } catch (error) {
                            console.error('Error removing member:', error);
                        }
                    }
                });
                
                membersList.appendChild(memberItem);
            });
        }
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>