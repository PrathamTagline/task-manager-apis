<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
  </head>
  <body>
    <h2>Welcome to the Dashboard</h2>

    <button id="logoutBtn">Logout</button>
    <button onclick="window.location.href='{% url 'profile_page' %}'">Go to Profile</button>

    <p id="message"></p>

    <script>
      const logoutBtn = document.getElementById("logoutBtn");
      const messageEl = document.getElementById("message");

      // 🚨 Check if the user is authenticated before accessing the dashboard
      const accessToken = localStorage.getItem("access_token");

      // If there's no access token, redirect to login page
      if (!accessToken) {
        messageEl.textContent =
          "You must be logged in to access the dashboard.";
        messageEl.style.color = "red";
        // Redirect to login page if not authenticated
        setTimeout(() => (window.location.href = "/accounts/signin/"), 2000);
      }

      // 📝 Logout handler
      logoutBtn.addEventListener("click", async () => {
        const refreshToken = localStorage.getItem("refresh_token");

        if (!refreshToken || !accessToken) {
          messageEl.textContent = "No tokens found. Already logged out?";
          return;
        }

        try {
          const response = await fetch(
            "http://127.0.0.1:8000/accounts/api/logout/",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + accessToken,
              },
              body: JSON.stringify({ refresh: refreshToken }),
            }
          );

          if (response.ok) {
            // Clear tokens from localStorage
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            window.location.href = "/accounts/signin/";
          } else {
            const data = await response.json();
            messageEl.textContent = data.detail || "Logout failed.";
            messageEl.style.color = "red";
          }
        } catch (error) {
          messageEl.textContent = "Error: " + error.message;
          messageEl.style.color = "red";
        }
      });
    </script>
  </body>
</html>
